# ScreenRec

Короткая инструкция по запуску и настройке.

## 1. Что делает проект
- `record.bat` — записывает экран в сегменты `.mkv`.
- `upload_move_loop.bat` — каждые N секунд отправляет готовые сегменты на NAS.
- `setup_check.bat` — проверяет, что все настроено правильно.

## 2. Что должно быть в папке проекта
- `record.bat`, `start_record_if_after_time.bat`, `upload_move_once.bat`, `upload_move_loop.bat`, `setup_check.bat`, `config.bat`
- `setup_tasks.bat` (автосоздание задач Планировщика)
- `run_record_hidden.vbs`, `run_upload_hidden.vbs` (скрытый запуск без окна консоли)
- Папка `Rclone`:
  - `Rclone\rclone.exe`
  - `Rclone\rclone.conf`
- Папка `ffmpeg`:
  - `ffmpeg\bin\ffmpeg.exe`
  - (опционально) `ffmpeg\bin\ffprobe.exe`

## 3. Быстрая настройка
1. Открой `config.bat` и проверь ключевые параметры:
   - `OUTDIR` — куда писать записи (например `C:\rec`)
   - `REMOTE_BASE` — путь на NAS (например `nas:/share/records`)
   - `AUDIO_DEVICE` — устройство звука (или пусто для видео без звука)
   - `VIDEO_FRAMERATE`, `DRAW_MOUSE`
   - `MIN_FREE_GB` — минимально свободное место перед стартом записи
   - `LOG_RETENTION_DAYS` — сколько дней хранить `rclone`-логи
2. Если нужен звук, запусти `list_audio_devices.bat` и вставь нужный `AUDIO_DEVICE` в `config.bat`.
3. Запусти `setup_check.bat`.
4. Если в конце `Result: OK` — проект готов к работе.

## 4. Ручной запуск
- Запись: `record.bat`
- Выгрузка в фоне: `upload_move_loop.bat`

## 5. Настройка Планировщика (строго: старт только при входе после указанного времени)
Важно: в `config.bat` поставь:
- `set PAUSE_ON_EXIT=0`
- `set START_AFTER_HHMM=1700` (или нужное время в формате `HHmm`)

### Быстрый вариант (рекомендуется)
1. Открой `cmd` от имени администратора.
2. Выполни:
   - `cd /d D:\Рабочий стол\ScreenRec`
   - `setup_tasks.bat`
3. Проверка:
   - `schtasks /Query /TN "ScreenRec_Record_OnLogon_AfterTime" /V /FO LIST`
   - `schtasks /Query /TN "ScreenRec_Upload_Loop" /V /FO LIST`
4. Удаление (если нужно):
   - `schtasks /Delete /TN "ScreenRec_Record_OnLogon_AfterTime" /F`
   - `schtasks /Delete /TN "ScreenRec_Upload_Loop" /F`

### Задача 1: запуск записи только при входе и только после нужного времени
1. Нажми `Win + R` -> `taskschd.msc`.
2. Выбери `Создать задачу...`.
3. Вкладка `Общие`:
   - Имя: `ScreenRec_Record_OnLogon_AfterTime`
   - Выбери `Выполнять только для пользователя, вошедшего в систему`.
4. Вкладка `Триггеры` -> `Создать`:
   - `При входе в систему` (для нужного пользователя).
5. Вкладка `Действия` -> `Создать`:
   - Программа: `wscript.exe`
   - Аргументы: `"D:\Рабочий стол\ScreenRec\run_record_hidden.vbs"`
   - Рабочая папка: `D:\Рабочий стол\ScreenRec` (опционально)
6. Вкладка `Параметры`:
   - `Если задача уже выполняется` -> `Не запускать новый экземпляр`.
7. Сохрани задачу.

### Задача 2: постоянная выгрузка на NAS
1. `Создать задачу...`
2. Имя: `ScreenRec_Upload_Loop`
3. `Общие`: `Выполнять только для пользователя, вошедшего в систему`.
4. `Триггеры`: `При входе в систему`.
5. `Действия`:
   - Программа: `wscript.exe`
   - Аргументы: `"D:\Рабочий стол\ScreenRec\run_upload_hidden.vbs"`
   - Рабочая папка: `D:\Рабочий стол\ScreenRec` (опционально)
6. `Параметры`:
   - `Если задача уже выполняется` -> `Не запускать новый экземпляр`.

## 6. Как это работает после настройки
- При входе в систему скрипт проверяет текущее время.
- Если текущее время меньше `START_AFTER_HHMM`, запись не запускается.
- Если время равно или больше `START_AFTER_HHMM`, запускается `record.bat`.
- Запись идет до выключения/перезагрузки ПК или ручной остановки процесса.
- Выгрузка на NAS работает в фоне после входа пользователя в систему.

## 7. Если что-то не работает
1. Запусти `setup_check.bat` и проверь, где ошибка.
2. Проверь логи выгрузки: `C:\rec\logs\rclone_move_YYYY-MM-DD.log`.
3. Проверь лог сессий записи: `C:\rec\logs\record_session.log`.
4. Убедись, что путь в задачах Планировщика совпадает с реальной папкой проекта.
